const Category = require("../models/Category");
const News = require("../models/News");
const slugify = require("slugify");

exports.runAutoNews = async (req, res) => {
  try {
    const categories = await Category.find({
      autoUpdateEnabled: true,
      status: "active"
    });

    let created = [];

    for (const cat of categories) {
      for (let i = 0; i < cat.dailyAutoUpdateLimit; i++) {
        const title = `Auto News ${new Date().toISOString()} - ${cat.name}`;

        const news = await News.create({
          title,
          slug: slugify(title, { lower: true }),
          description: "This is auto generated news (TEST)",
          category: cat._id,
          contentBlocks: [
            {
              type: "text",
              value: "This news was auto generated by system for testing."
            }
          ],
          aiGenerated: true,
         // : "system",
         createdBy: "admin",
          status: "draft"
        });

        created.push(news);
      }
    }

    res.json({
      message: "Auto news generated",
      count: created.length
    });

  } catch (err) {
    console.error(err);
    res.status(500).json({ message: err.message });
  }
};
